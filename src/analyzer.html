<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .upload-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .demo-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .demo-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .status {
            margin-left: auto;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            background: #e9ecef;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .dashboard {
            padding: 30px;
            display: none;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .card.income { border-left-color: #28a745; }
        .card.expenses { border-left-color: #dc3545; }
        .card.balance { border-left-color: #007bff; }
        .card.transactions { border-left-color: #6f42c1; }

        .card-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .transactions-table {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .table-controls {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .category-filter {
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 100px 1fr 100px 120px 80px;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .transaction-item:hover {
            background-color: #f8f9fa;
        }

        .transaction-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .transaction-description {
            font-weight: 500;
        }

        .transaction-amount {
            font-weight: bold;
            text-align: right;
        }

        .transaction-amount.positive {
            color: #28a745;
        }

        .transaction-amount.negative {
            color: #dc3545;
        }

        .transaction-category {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }

        .insights-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .insight-item {
            padding: 16px;
            border-left: 4px solid #17a2b8;
            background: #f8f9fa;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .export-section {
            margin-top: 30px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .transaction-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .file-upload {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Personal Finance Analyzer</h1>
            <p>Upload your transaction data and get intelligent insights powered by AI</p>
        </div>

        <div class="upload-section">
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" />
                    <label for="csvFile" class="file-label">üìÅ Upload CSV File</label>
                </div>
                <button class="demo-btn" onclick="loadDemoData()">üéØ Try Demo Data</button>
                <div class="status" id="uploadStatus">Ready to upload</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your financial data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="summary-cards">
                <div class="card income">
                    <div class="card-value" id="totalIncome">$0</div>
                    <div class="card-label">Total Income</div>
                </div>
                <div class="card expenses">
                    <div class="card-value" id="totalExpenses">$0</div>
                    <div class="card-label">Total Expenses</div>
                </div>
                <div class="card balance">
                    <div class="card-value" id="netBalance">$0</div>
                    <div class="card-label">Net Balance</div>
                </div>
                <div class="card transactions">
                    <div class="card-value" id="transactionCount">0</div>
                    <div class="card-label">Transactions</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Spending by Category</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Trends</div>
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <div class="insights-panel">
                <div class="chart-title">üí° AI-Powered Insights</div>
                <div id="insightsList"></div>
            </div>

            <div class="transactions-table">
                <div class="chart-title">Recent Transactions</div>
                <div class="table-controls">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search transactions..." />
                    <select class="category-filter" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="transactions-list" id="transactionsList"></div>
            </div>

            <div class="export-section">
                <button class="export-btn" onclick="exportReport()">üìä Export Analysis Report</button>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let categoryMappings = {};
        let charts = {};

        // Embedded category mappings (no external file needed)
        function loadCategoryMappings() {
            categoryMappings = {
                categories: {
                    "Income": { 
                        keywords: ["salary", "deposit", "paycheck", "freelance", "payment", "income", "wages", "bonus"],
                        merchants: [],
                        color: "#28a745", 
                        icon: "üí∞" 
                    },
                    "Housing": { 
                        keywords: ["rent", "mortgage", "property tax", "hoa", "property management"],
                        merchants: ["rent payment", "property"],
                        color: "#6f42c1", 
                        icon: "üè†" 
                    },
                    "Groceries": { 
                        keywords: ["grocery", "market", "food", "supermarket"],
                        merchants: ["safeway", "whole foods", "trader joe", "costco", "fred meyer", "qfc", "kroger", "walmart", "target", "pcc", "metropolitan market"],
                        color: "#20c997", 
                        icon: "üõí" 
                    },
                    "Food & Dining": { 
                        keywords: ["restaurant", "cafe", "coffee", "dining", "bar", "pub", "grill", "pizza", "delivery"],
                        merchants: ["starbucks", "chipotle", "mcdonald", "subway", "panera", "olive garden", "taco bell", "five guys", "pizza hut", "dunkin", "kfc"],
                        color: "#fd7e14", 
                        icon: "üçΩÔ∏è" 
                    },
                    "Transportation": { 
                        keywords: ["gas", "fuel", "parking", "toll", "car wash", "oil change", "tire", "repair", "maintenance"],
                        merchants: ["shell", "chevron", "exxon", "bp", "mobil", "arco", "76", "costco gas", "uber", "lyft", "taxi"],
                        color: "#007bff", 
                        icon: "üöó" 
                    },
                    "Utilities": { 
                        keywords: ["electric", "electricity", "gas bill", "water", "sewer", "internet", "phone", "cable", "trash"],
                        merchants: ["pse", "seattle city light", "puget sound energy", "comcast", "xfinity", "verizon", "at&t", "t-mobile"],
                        color: "#6c757d", 
                        icon: "‚ö°" 
                    },
                    "Entertainment": { 
                        keywords: ["movie", "theater", "streaming", "subscription", "music", "games", "concert"],
                        merchants: ["netflix", "spotify", "apple music", "hulu", "disney", "amazon prime", "youtube", "amc", "regal"],
                        color: "#e83e8c", 
                        icon: "üé¨" 
                    },
                    "Shopping": { 
                        keywords: ["store", "shopping", "retail", "online", "purchase", "buy"],
                        merchants: ["amazon", "target", "walmart", "best buy", "nordstrom", "macy", "microsoft", "apple store"],
                        color: "#17a2b8", 
                        icon: "üõçÔ∏è" 
                    },
                    "Healthcare": { 
                        keywords: ["medical", "doctor", "dentist", "pharmacy", "hospital", "clinic", "prescription"],
                        merchants: ["cvs", "walgreens", "rite aid", "kaiser", "virginia mason", "pharmacy"],
                        color: "#dc3545", 
                        icon: "üè•" 
                    },
                    "Insurance": { 
                        keywords: ["insurance", "premium", "policy"],
                        merchants: ["geico", "state farm", "allstate", "progressive", "usaa", "aaa"],
                        color: "#343a40", 
                        icon: "üõ°Ô∏è" 
                    },
                    "Health & Fitness": { 
                        keywords: ["gym", "fitness", "yoga", "trainer", "supplement", "workout"],
                        merchants: ["24 hour fitness", "planet fitness", "gold gym", "la fitness", "gym"],
                        color: "#28a745", 
                        icon: "üí™" 
                    },
                    "Recreation": { 
                        keywords: ["sports", "outdoor", "recreation", "hobby", "game", "equipment"],
                        merchants: ["rei", "dick sporting", "big 5", "sports authority"],
                        color: "#ffc107", 
                        icon: "‚öΩ" 
                    },
                    "Home Improvement": { 
                        keywords: ["hardware", "improvement", "repair", "tools", "garden", "lawn"],
                        merchants: ["home depot", "lowe", "ace hardware", "menards"],
                        color: "#795548", 
                        icon: "üî®" 
                    },
                    "Miscellaneous": { 
                        keywords: ["other", "misc", "unknown", "cash", "atm", "fee"],
                        merchants: [],
                        color: "#adb5bd", 
                        icon: "‚ùì" 
                    }
                }
            };
        }

        // Auto-categorize transaction
        function categorizeTransaction(description, amount) {
            if (!categoryMappings.categories) return 'Miscellaneous';
            
            const desc = description.toLowerCase();
            
            // Check each category
            for (const [category, data] of Object.entries(categoryMappings.categories)) {
                // Check keywords
                if (data.keywords && data.keywords.some(keyword => desc.includes(keyword.toLowerCase()))) {
                    return category;
                }
                
                // Check merchants
                if (data.merchants && data.merchants.some(merchant => desc.includes(merchant.toLowerCase()))) {
                    return category;
                }
            }
            
            return 'Miscellaneous';
        }

        // Embedded demo data (no external file needed)
        function loadDemoData() {
            showLoading(true);
            
            const demoCSV = `Date,Description,Amount,Category,Account
2024-07-26,Salary Deposit,4500.00,Income,Checking
2024-07-25,Starbucks Coffee,5.47,Food & Dining,Credit Card
2024-07-25,Shell Gas Station,42.33,Transportation,Credit Card
2024-07-24,Amazon Purchase,89.99,Shopping,Credit Card
2024-07-24,Safeway Grocery,127.84,Groceries,Debit Card
2024-07-23,Netflix Subscription,15.99,Entertainment,Credit Card
2024-07-22,Electric Bill - PSE,145.67,Utilities,Checking
2024-07-21,Target Shopping,67.42,Shopping,Credit Card
2024-07-20,Chipotle Mexican Grill,12.85,Food & Dining,Credit Card
2024-07-19,Chevron Gas,38.91,Transportation,Credit Card
2024-07-18,REI Outdoor Gear,234.56,Recreation,Credit Card
2024-07-17,Whole Foods Market,92.33,Groceries,Debit Card
2024-07-16,Spotify Premium,9.99,Entertainment,Credit Card
2024-07-15,Water Bill,34.22,Utilities,Checking
2024-07-14,McDonald's,8.47,Food & Dining,Credit Card
2024-07-13,Costco Wholesale,178.92,Groceries,Credit Card
2024-07-12,Rent Payment,1850.00,Housing,Checking
2024-07-11,Uber Ride,23.45,Transportation,Credit Card
2024-07-10,Best Buy Electronics,299.99,Shopping,Credit Card
2024-07-09,Panera Bread,14.32,Food & Dining,Credit Card
2024-07-08,Internet Bill - Comcast,79.99,Utilities,Checking
2024-07-07,CVS Pharmacy,27.84,Healthcare,Credit Card
2024-07-06,Home Depot,156.78,Home Improvement,Credit Card
2024-07-05,Trader Joe's,65.43,Groceries,Debit Card
2024-07-04,Movie Theater AMC,28.50,Entertainment,Credit Card
2024-07-03,Car Insurance,167.50,Insurance,Checking
2024-07-02,Freelance Payment,850.00,Income,Checking
2024-07-01,Gym Membership,49.99,Health & Fitness,Credit Card
2024-06-30,Starbucks Coffee,6.23,Food & Dining,Credit Card
2024-06-29,Shell Gas Station,45.67,Transportation,Credit Card
2024-06-28,Amazon Prime,139.00,Shopping,Credit Card
2024-06-27,QFC Grocery,134.56,Groceries,Debit Card
2024-06-26,Salary Deposit,4500.00,Income,Checking
2024-06-25,Hulu Subscription,12.99,Entertainment,Credit Card
2024-06-24,Gas Bill,67.89,Utilities,Checking
2024-06-23,Nordstrom Shopping,189.44,Shopping,Credit Card
2024-06-22,Taco Bell,9.67,Food & Dining,Credit Card
2024-06-21,76 Gas Station,41.23,Transportation,Credit Card
2024-06-20,Dick's Sporting Goods,123.45,Recreation,Credit Card
2024-06-19,PCC Natural Markets,87.65,Groceries,Debit Card
2024-06-18,Apple Music,10.99,Entertainment,Credit Card
2024-06-17,Sewer Bill,45.33,Utilities,Checking
2024-06-16,Subway Sandwich,11.25,Food & Dining,Credit Card
2024-06-15,Fred Meyer,167.88,Groceries,Credit Card
2024-06-14,Lyft Ride,18.76,Transportation,Credit Card
2024-06-13,Microsoft Store,79.99,Shopping,Credit Card
2024-06-12,Rent Payment,1850.00,Housing,Checking
2024-06-11,Olive Garden,43.87,Food & Dining,Credit Card
2024-06-10,Chevron Gas,39.54,Transportation,Credit Card
2024-06-09,Lowe's Home Improvement,89.33,Home Improvement,Credit Card
2024-06-08,Metropolitan Market,76.22,Groceries,Debit Card
2024-06-07,Disney Plus,7.99,Entertainment,Credit Card
2024-06-06,Dentist Visit,150.00,Healthcare,Credit Card
2024-06-05,Macy's Shopping,156.78,Shopping,Credit Card
2024-06-04,Phone Bill - Verizon,85.67,Utilities,Checking
2024-06-03,Five Guys Burgers,16.45,Food & Dining,Credit Card
2024-06-02,Arco Gas,37.89,Transportation,Credit Card
2024-06-01,Health Insurance,234.50,Insurance,Checking
2024-05-31,Starbucks Coffee,5.89,Food & Dining,Credit Card
2024-05-30,Costco Gas,52.33,Transportation,Credit Card
2024-05-29,Target Shopping,98.76,Shopping,Credit Card
2024-05-28,Whole Foods Market,112.45,Groceries,Debit Card
2024-05-27,Salary Deposit,4500.00,Income,Checking
2024-05-26,YouTube Premium,11.99,Entertainment,Credit Card
2024-05-25,Electric Bill - PSE,123.45,Utilities,Checking
2024-05-24,Walgreens Pharmacy,31.67,Healthcare,Credit Card
2024-05-23,Pizza Hut,22.34,Food & Dining,Credit Card
2024-05-22,Shell Gas Station,44.56,Transportation,Credit Card
2024-05-21,Amazon Purchase,67.89,Shopping,Credit Card
2024-05-20,Safeway Grocery,145.67,Groceries,Debit Card
2024-05-19,Car Wash,15.00,Transportation,Credit Card
2024-05-18,Freelance Payment,1200.00,Income,Checking
2024-05-17,Rent Payment,1850.00,Housing,Checking
2024-05-16,Starbucks Coffee,6.78,Food & Dining,Credit Card
2024-05-15,Water Bill,32.11,Utilities,Checking
2024-05-14,Best Buy Electronics,189.99,Shopping,Credit Card
2024-05-13,Trader Joe's,78.34,Groceries,Debit Card
2024-05-12,Uber Eats Delivery,24.67,Food & Dining,Credit Card
2024-05-11,76 Gas Station,43.22,Transportation,Credit Card
2024-05-10,Home Depot,234.56,Home Improvement,Credit Card
2024-05-09,QFC Grocery,89.45,Groceries,Debit Card
2024-05-08,Netflix Subscription,15.99,Entertainment,Credit Card
2024-05-07,Internet Bill - Comcast,79.99,Utilities,Checking
2024-05-06,Panera Bread,13.45,Food & Dining,Credit Card
2024-05-05,Chevron Gas,41.89,Transportation,Credit Card
2024-05-04,REI Outdoor Gear,178.90,Recreation,Credit Card
2024-05-03,PCC Natural Markets,95.67,Groceries,Debit Card
2024-05-02,Gym Membership,49.99,Health & Fitness,Credit Card
2024-05-01,Car Insurance,167.50,Insurance,Checking
2024-04-30,Starbucks Coffee,5.23,Food & Dining,Credit Card
2024-04-29,Arco Gas,38.76,Transportation,Credit Card
2024-04-28,Amazon Prime Renewal,139.00,Shopping,Credit Card
2024-04-27,Fred Meyer,156.78,Groceries,Debit Card
2024-04-26,Salary Deposit,4500.00,Income,Checking
2024-04-25,Spotify Premium,9.99,Entertainment,Credit Card
2024-04-24,Gas Bill,89.45,Utilities,Checking
2024-04-23,Target Shopping,123.67,Shopping,Credit Card
2024-04-22,Chipotle Mexican Grill,14.56,Food & Dining,Credit Card
2024-04-21,Shell Gas Station,46.33,Transportation,Credit Card
2024-04-20,Dick's Sporting Goods,234.78,Recreation,Credit Card
2024-04-19,Whole Foods Market,101.23,Groceries,Debit Card
2024-04-18,Apple Music,10.99,Entertainment,Credit Card
2024-04-17,Sewer Bill,43.22,Utilities,Checking
2024-04-16,McDonald's,7.89,Food & Dining,Credit Card
2024-04-15,Costco Wholesale,189.45,Groceries,Credit Card
2024-04-14,Uber Ride,19.67,Transportation,Credit Card
2024-04-13,Microsoft Store,99.99,Shopping,Credit Card
2024-04-12,Rent Payment,1850.00,Housing,Checking`;

            setTimeout(() => {
                parseCSV(demoCSV);
                document.getElementById('uploadStatus').textContent = 'Demo data loaded successfully!';
                document.getElementById('uploadStatus').className = 'status success';
                showLoading(false);
            }, 1000); // Add slight delay for loading animation
        }

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                    document.getElementById('uploadStatus').textContent = `${file.name} uploaded successfully!`;
                    document.getElementById('uploadStatus').className = 'status success';
                    showLoading(false);
                };
                reader.readAsText(file);
            }
        });

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard').style.display = show ? 'none' : 'block';
        }

        // Optimized CSV parsing with async processing
        function parseCSV(csvText) {
            showLoading(true);
            
            // Use setTimeout to make parsing non-blocking
            setTimeout(() => {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // Process in smaller chunks for better performance
                const chunkSize = 50;
                transactions = [];
                
                const processChunk = (startIndex) => {
                    const endIndex = Math.min(startIndex + chunkSize, lines.length);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        if (i === 0) continue; // Skip header
                        
                        const values = parseCSVLine(lines[i]);
                        const transaction = {};
                        
                        headers.forEach((header, index) => {
                            transaction[header] = values[index] || '';
                        });
                        
                        // Auto-categorize if category is missing or generic
                        if (!transaction.Category || transaction.Category === 'Miscellaneous') {
                            transaction.Category = categorizeTransaction(transaction.Description, parseFloat(transaction.Amount));
                        }
                        
                        transaction.Amount = parseFloat(transaction.Amount) || 0;
                        transaction.Date = new Date(transaction.Date);
                        
                        if (transaction.Amount !== 0) {
                            transactions.push(transaction);
                        }
                    }
                    
                    // Process next chunk or finish
                    if (endIndex < lines.length) {
                        setTimeout(() => processChunk(endIndex), 10);
                    } else {
                        // All done - update dashboard
                        updateDashboard();
                        showLoading(false);
                    }
                };
                
                processChunk(0);
            }, 100);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Optimized dashboard update with async operations
        function updateDashboard() {
            // Update summary cards immediately (fastest)
            updateSummaryCards();
            
            // Stagger chart updates to prevent blocking
            setTimeout(() => updateCharts(), 50);
            setTimeout(() => updateInsights(), 100);
            setTimeout(() => updateTransactionsList(), 150);
            setTimeout(() => updateCategoryFilter(), 200);
        }

        function updateSummaryCards() {
            const income = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const expenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const balance = income - expenses;

            document.getElementById('totalIncome').textContent = `$${income.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `$${expenses.toLocaleString()}`;
            document.getElementById('netBalance').textContent = `$${balance.toLocaleString()}`;
            document.getElementById('transactionCount').textContent = transactions.length.toLocaleString();
        }

        function updateCharts() {
            createCategoryChart();
            createTrendsChart();
        }

        // Optimized chart creation with performance improvements
        function createCategoryChart() {
            const categoryTotals = {};
            const expenseTransactions = transactions.filter(t => t.Amount < 0);
            
            // Use forEach instead of reduce for better performance with large datasets
            expenseTransactions.forEach(t => {
                const category = t.Category || 'Miscellaneous';
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.abs(t.Amount);
            });

            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8); // Limit to top 8 for performance

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([,amount]) => amount);
            const colors = labels.map(category => 
                categoryMappings.categories[category]?.color || '#adb5bd'
            );

            // Destroy existing chart if it exists
            if (charts.category) {
                charts.category.destroy();
            }

            const ctx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800 // Faster animation
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTrendsChart() {
            const monthlyData = {};
            
            // Optimized monthly aggregation
            transactions.forEach(t => {
                const monthKey = `${t.Date.getFullYear()}-${String(t.Date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expenses: 0 };
                }
                
                if (t.Amount > 0) {
                    monthlyData[monthKey].income += t.Amount;
                } else {
                    monthlyData[monthKey].expenses += Math.abs(t.Amount);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const incomeData = sortedMonths.map(month => monthlyData[month].income);
            const expenseData = sortedMonths.map(month => monthlyData[month].expenses);

            // Destroy existing chart
            if (charts.trends) {
                charts.trends.destroy();
            }

            const ctx = document.getElementById('trendsChart').getContext('2d');
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        const date = new Date(year, monthNum - 1);
                        return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '

        function updateInsights() {
            const insights = generateInsights();
            const insightsList = document.getElementById('insightsList');
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div>${insight.description}</div>
                </div>
            `).join('');
        }

        function generateInsights() {
            const insights = [];
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            
            // Category analysis
            const categoryTotals = {};
            transactions.filter(t => t.Amount < 0).forEach(t => {
                const category = t.Category || 'Miscellaneous';
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.abs(t.Amount);
            });

            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            if (topCategory) {
                const percentage = ((topCategory[1] / totalExpenses) * 100).toFixed(1);
                insights.push({
                    title: `Highest Spending Category: ${topCategory[0]}`,
                    description: `You spent $${topCategory[1].toLocaleString()} (${percentage}%) on ${topCategory[0]}. Consider if this aligns with your priorities.`
                });
            }

            // Savings rate
            const savingsRate = ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1);
            insights.push({
                title: `Savings Rate: ${savingsRate}%`,
                description: savingsRate > 20 ? 
                    'Excellent! You\'re saving over 20% of your income.' :
                    savingsRate > 10 ? 
                    'Good savings rate! Consider increasing to 20% if possible.' :
                    'Consider reducing expenses to increase your savings rate.'
            });

            // Dining analysis
            const diningSpend = categoryTotals['Food & Dining'] || 0;
            const grocerySpend = categoryTotals['Groceries'] || 0;
            if (diningSpend > grocerySpend) {
                insights.push({
                    title: 'Dining vs Groceries',
                    description: `You spend more on dining out ($${diningSpend.toLocaleString()}) than groceries ($${grocerySpend.toLocaleString()}). Cooking at home more could save money.`
                });
            }

            return insights;
        }

        function updateTransactionsList() {
            currentTransactionsToShow = transactions;
            currentlyLoaded = 25; // Reset load counter
            renderTransactions(transactions);
        }
        
        // Add event listeners with optimized filtering
        document.getElementById('searchInput').addEventListener('input', filterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', filterTransactions);

        // Optimized transaction list rendering with virtual scrolling concept
        function renderTransactions(transactionsToShow) {
            const list = document.getElementById('transactionsList');
            
            // Limit initial render to 25 transactions for better performance
            const maxInitialRender = 25;
            const transactionsToRender = transactionsToShow.slice(0, maxInitialRender);
            
            list.innerHTML = transactionsToRender.map(t => {
                const category = categoryMappings.categories[t.Category] || categoryMappings.categories['Miscellaneous'];
                const amountClass = t.Amount > 0 ? 'positive' : 'negative';
                const formattedAmount = Math.abs(t.Amount).toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-date">${t.Date.toLocaleDateString('en-US', { month: 'short', day: '2-digit' })}</div>
                        <div class="transaction-description">${t.Description}</div>
                        <div class="transaction-amount ${amountClass}">${formattedAmount}</div>
                        <div class="transaction-category">
                            <span class="category-badge" style="background-color: ${category.color}">
                                ${category.icon} ${t.Category}
                            </span>
                        </div>
                        <div>${t.Account}</div>
                    </div>
                `;
            }).join('');
            
            // Add "Load More" button if there are more transactions
            if (transactionsToShow.length > maxInitialRender) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.style.cssText = 'text-align: center; padding: 20px;';
                loadMoreBtn.innerHTML = `
                    <button onclick="loadMoreTransactions()" style="
                        background: #667eea; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 6px; 
                        cursor: pointer;
                        font-weight: 500;
                    ">
                        Load More (${transactionsToShow.length - maxInitialRender} remaining)
                    </button>
                `;
                list.appendChild(loadMoreBtn);
            }
        }

        // Global variable to track loaded transactions
        let currentTransactionsToShow = [];
        let currentlyLoaded = 25;

        function loadMoreTransactions() {
            const nextBatch = 25;
            const endIndex = Math.min(currentlyLoaded + nextBatch, currentTransactionsToShow.length);
            
            const list = document.getElementById('transactionsList');
            const loadMoreBtn = list.querySelector('button');
            if (loadMoreBtn) loadMoreBtn.parentElement.remove();
            
            for (let i = currentlyLoaded; i < endIndex; i++) {
                const t = currentTransactionsToShow[i];
                const category = categoryMappings.categories[t.Category] || categoryMappings.categories['Miscellaneous'];
                const amountClass = t.Amount > 0 ? 'positive' : 'negative';
                const formattedAmount = Math.abs(t.Amount).toLocaleString('en-US', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
                
                const transactionDiv = document.createElement('div');
                transactionDiv.className = 'transaction-item';
                transactionDiv.innerHTML = `
                    <div class="transaction-date">${t.Date.toLocaleDateString('en-US', { month: 'short', day: '2-digit' })}</div>
                    <div class="transaction-description">${t.Description}</div>
                    <div class="transaction-amount ${amountClass}">${formattedAmount}</div>
                    <div class="transaction-category">
                        <span class="category-badge" style="background-color: ${category.color}">
                            ${category.icon} ${t.Category}
                        </span>
                    </div>
                    <div>${t.Account}</div>
                `;
                list.appendChild(transactionDiv);
            }
            
            currentlyLoaded = endIndex;
            
            if (endIndex < currentTransactionsToShow.length) {
                const loadMoreBtn = document.createElement('div');
                loadMoreBtn.style.cssText = 'text-align: center; padding: 20px;';
                loadMoreBtn.innerHTML = `
                    <button onclick="loadMoreTransactions()" style="
                        background: #667eea; 
                        color: white; 
                        border: none; 
                        padding: 10px 20px; 
                        border-radius: 6px; 
                        cursor: pointer;
                        font-weight: 500;
                    ">
                        Load More (${currentTransactionsToShow.length - endIndex} remaining)
                    </button>
                `;
                list.appendChild(loadMoreBtn);
            }
        }

        function updateCategoryFilter() {
            const categories = [...new Set(transactions.map(t => t.Category))].sort();
            const filter = document.getElementById('categoryFilter');
            
            filter.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Optimized filtering with debouncing
        let filterTimeout;
        
        function filterTransactions() {
            // Clear previous timeout to debounce rapid typing
            clearTimeout(filterTimeout);
            
            filterTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const selectedCategory = document.getElementById('categoryFilter').value;
                
                let filtered = transactions;
                
                if (searchTerm) {
                    filtered = filtered.filter(t => 
                        t.Description.toLowerCase().includes(searchTerm) ||
                        t.Category.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (selectedCategory) {
                    filtered = filtered.filter(t => t.Category === selectedCategory);
                }
                
                currentTransactionsToShow = filtered;
                currentlyLoaded = 25; // Reset load counter
                renderTransactions(filtered);
            }, 300); // 300ms debounce
        }

        // Export functionality
        function exportReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const balance = totalIncome - totalExpenses;
            
            return `PERSONAL FINANCE ANALYSIS REPORT
Generated: ${new Date().toLocaleDateString()}

SUMMARY
=======
Total Income: $${totalIncome.toLocaleString()}
Total Expenses: $${totalExpenses.toLocaleString()}
Net Balance: $${balance.toLocaleString()}
Total Transactions: ${transactions.length}
Savings Rate: ${((balance / totalIncome) * 100).toFixed(1)}%

SPENDING BY CATEGORY
==================
${Object.entries(transactions.filter(t => t.Amount < 0).reduce((acc, t) => {
    const cat = t.Category || 'Miscellaneous';
    acc[cat] = (acc[cat] || 0) + Math.abs(t.Amount);
    return acc;
}, {})).sort(([,a], [,b]) => b - a).map(([cat, amount]) => 
    `${cat}: $${amount.toLocaleString()}`
).join('\n')}

This report was generated by the Personal Finance Analyzer
Built with Claude AI assistance
`;
        }

        // Initialize - no external file loading needed
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoryMappings(); // Now uses embedded data
        });
    </script>
</body>
</html> + (value/1000).toFixed(0) + 'k';
                                },
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateInsights() {
            const insights = generateInsights();
            const insightsList = document.getElementById('insightsList');
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div>${insight.description}</div>
                </div>
            `).join('');
        }

        function generateInsights() {
            const insights = [];
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            
            // Category analysis
            const categoryTotals = {};
            transactions.filter(t => t.Amount < 0).forEach(t => {
                const category = t.Category || 'Miscellaneous';
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.abs(t.Amount);
            });

            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            if (topCategory) {
                const percentage = ((topCategory[1] / totalExpenses) * 100).toFixed(1);
                insights.push({
                    title: `Highest Spending Category: ${topCategory[0]}`,
                    description: `You spent $${topCategory[1].toLocaleString()} (${percentage}%) on ${topCategory[0]}. Consider if this aligns with your priorities.`
                });
            }

            // Savings rate
            const savingsRate = ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1);
            insights.push({
                title: `Savings Rate: ${savingsRate}%`,
                description: savingsRate > 20 ? 
                    'Excellent! You\'re saving over 20% of your income.' :
                    savingsRate > 10 ? 
                    'Good savings rate! Consider increasing to 20% if possible.' :
                    'Consider reducing expenses to increase your savings rate.'
            });

            // Dining analysis
            const diningSpend = categoryTotals['Food & Dining'] || 0;
            const grocerySpend = categoryTotals['Groceries'] || 0;
            if (diningSpend > grocerySpend) {
                insights.push({
                    title: 'Dining vs Groceries',
                    description: `You spend more on dining out ($${diningSpend.toLocaleString()}) than groceries ($${grocerySpend.toLocaleString()}). Cooking at home more could save money.`
                });
            }

            return insights;
        }

        function updateTransactionsList() {
            renderTransactions(transactions);
        }

        function renderTransactions(transactionsToShow) {
            const list = document.getElementById('transactionsList');
            
            list.innerHTML = transactionsToShow.slice(0, 50).map(t => {
                const category = categoryMappings.categories[t.Category] || categoryMappings.categories['Miscellaneous'];
                const amountClass = t.Amount > 0 ? 'positive' : 'negative';
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-date">${t.Date.toLocaleDateString()}</div>
                        <div class="transaction-description">${t.Description}</div>
                        <div class="transaction-amount ${amountClass}">$${Math.abs(t.Amount).toLocaleString()}</div>
                        <div class="transaction-category">
                            <span class="category-badge" style="background-color: ${category.color}">
                                ${category.icon} ${t.Category}
                            </span>
                        </div>
                        <div>${t.Account}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCategoryFilter() {
            const categories = [...new Set(transactions.map(t => t.Category))].sort();
            const filter = document.getElementById('categoryFilter');
            
            filter.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', filterTransactions);

        function filterTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            let filtered = transactions;
            
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.Description.toLowerCase().includes(searchTerm) ||
                    t.Category.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedCategory) {
                filtered = filtered.filter(t => t.Category === selectedCategory);
            }
            
            renderTransactions(filtered);
        }

        // Export functionality
        function exportReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const balance = totalIncome - totalExpenses;
            
            return `PERSONAL FINANCE ANALYSIS REPORT
Generated: ${new Date().toLocaleDateString()}

SUMMARY
=======
Total Income: $${totalIncome.toLocaleString()}
Total Expenses: $${totalExpenses.toLocaleString()}
Net Balance: $${balance.toLocaleString()}
Total Transactions: ${transactions.length}
Savings Rate: ${((balance / totalIncome) * 100).toFixed(1)}%

SPENDING BY CATEGORY
==================
${Object.entries(transactions.filter(t => t.Amount < 0).reduce((acc, t) => {
    const cat = t.Category || 'Miscellaneous';
    acc[cat] = (acc[cat] || 0) + Math.abs(t.Amount);
    return acc;
}, {})).sort(([,a], [,b]) => b - a).map(([cat, amount]) => 
    `${cat}: $${amount.toLocaleString()}`
).join('\n')}

This report was generated by the Personal Finance Analyzer
Built with Claude AI assistance
`;
        }

        // Initialize - no external file loading needed
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoryMappings(); // Now uses embedded data
        });
    </script>
</body>
</html>

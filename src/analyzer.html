<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .upload-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        .file-upload {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-label {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .demo-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .demo-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .status {
            margin-left: auto;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            background: #e9ecef;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .dashboard {
            padding: 30px;
            display: none;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
        }

        .card.income { border-left-color: #28a745; }
        .card.expenses { border-left-color: #dc3545; }
        .card.balance { border-left-color: #007bff; }
        .card.transactions { border-left-color: #6f42c1; }

        .card-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .card-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .transactions-table {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .table-controls {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .category-filter {
            padding: 10px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
            cursor: pointer;
        }

        .transactions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: grid;
            grid-template-columns: 100px 1fr 100px 120px 80px;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid #eee;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .transaction-item:hover {
            background-color: #f8f9fa;
        }

        .transaction-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .transaction-description {
            font-weight: 500;
        }

        .transaction-amount {
            font-weight: bold;
            text-align: right;
        }

        .transaction-amount.positive {
            color: #28a745;
        }

        .transaction-amount.negative {
            color: #dc3545;
        }

        .transaction-category {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }

        .insights-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-top: 30px;
        }

        .insight-item {
            padding: 16px;
            border-left: 4px solid #17a2b8;
            background: #f8f9fa;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .export-section {
            margin-top: 30px;
            text-align: center;
        }

        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .transaction-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .file-upload {
                flex-direction: column;
                align-items: stretch;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Personal Finance Analyzer</h1>
            <p>Upload your transaction data and get intelligent insights powered by AI</p>
        </div>

        <div class="upload-section">
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" />
                    <label for="csvFile" class="file-label">üìÅ Upload CSV File</label>
                </div>
                <button class="demo-btn" onclick="loadDemoData()">üéØ Try Demo Data</button>
                <div class="status" id="uploadStatus">Ready to upload</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your financial data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="summary-cards">
                <div class="card income">
                    <div class="card-value" id="totalIncome">$0</div>
                    <div class="card-label">Total Income</div>
                </div>
                <div class="card expenses">
                    <div class="card-value" id="totalExpenses">$0</div>
                    <div class="card-label">Total Expenses</div>
                </div>
                <div class="card balance">
                    <div class="card-value" id="netBalance">$0</div>
                    <div class="card-label">Net Balance</div>
                </div>
                <div class="card transactions">
                    <div class="card-value" id="transactionCount">0</div>
                    <div class="card-label">Transactions</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Spending by Category</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Trends</div>
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <div class="insights-panel">
                <div class="chart-title">üí° AI-Powered Insights</div>
                <div id="insightsList"></div>
            </div>

            <div class="transactions-table">
                <div class="chart-title">Recent Transactions</div>
                <div class="table-controls">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search transactions..." />
                    <select class="category-filter" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="transactions-list" id="transactionsList"></div>
            </div>

            <div class="export-section">
                <button class="export-btn" onclick="exportReport()">üìä Export Analysis Report</button>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let categoryMappings = {};
        let charts = {};

        // Load category mappings
        async function loadCategoryMappings() {
            try {
                const response = await fetch('./data/category_mappings.json');
                categoryMappings = await response.json();
            } catch (error) {
                console.warn('Could not load category mappings, using defaults');
                categoryMappings = getDefaultCategories();
            }
        }

        function getDefaultCategories() {
            return {
                categories: {
                    "Income": { color: "#28a745", icon: "üí∞" },
                    "Housing": { color: "#6f42c1", icon: "üè†" },
                    "Groceries": { color: "#20c997", icon: "üõí" },
                    "Food & Dining": { color: "#fd7e14", icon: "üçΩÔ∏è" },
                    "Transportation": { color: "#007bff", icon: "üöó" },
                    "Utilities": { color: "#6c757d", icon: "‚ö°" },
                    "Entertainment": { color: "#e83e8c", icon: "üé¨" },
                    "Shopping": { color: "#17a2b8", icon: "üõçÔ∏è" },
                    "Healthcare": { color: "#dc3545", icon: "üè•" },
                    "Miscellaneous": { color: "#adb5bd", icon: "‚ùì" }
                }
            };
        }

        // Auto-categorize transaction
        function categorizeTransaction(description, amount) {
            if (!categoryMappings.categories) return 'Miscellaneous';
            
            const desc = description.toLowerCase();
            
            // Check each category
            for (const [category, data] of Object.entries(categoryMappings.categories)) {
                // Check keywords
                if (data.keywords && data.keywords.some(keyword => desc.includes(keyword.toLowerCase()))) {
                    return category;
                }
                
                // Check merchants
                if (data.merchants && data.merchants.some(merchant => desc.includes(merchant.toLowerCase()))) {
                    return category;
                }
            }
            
            return 'Miscellaneous';
        }

        // Load demo data
        async function loadDemoData() {
            showLoading(true);
            try {
                const response = await fetch('./data/sample_transactions.csv');
                const csvText = await response.text();
                parseCSV(csvText);
                document.getElementById('uploadStatus').textContent = 'Demo data loaded successfully!';
                document.getElementById('uploadStatus').className = 'status success';
            } catch (error) {
                console.error('Error loading demo data:', error);
                document.getElementById('uploadStatus').textContent = 'Error loading demo data';
            }
            showLoading(false);
        }

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                    document.getElementById('uploadStatus').textContent = `${file.name} uploaded successfully!`;
                    document.getElementById('uploadStatus').className = 'status success';
                    showLoading(false);
                };
                reader.readAsText(file);
            }
        });

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard').style.display = show ? 'none' : 'block';
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            transactions = lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const transaction = {};
                
                headers.forEach((header, index) => {
                    transaction[header] = values[index] || '';
                });
                
                // Auto-categorize if category is missing or generic
                if (!transaction.Category || transaction.Category === 'Miscellaneous') {
                    transaction.Category = categorizeTransaction(transaction.Description, parseFloat(transaction.Amount));
                }
                
                transaction.Amount = parseFloat(transaction.Amount) || 0;
                transaction.Date = new Date(transaction.Date);
                
                return transaction;
            }).filter(t => t.Amount !== 0);

            updateDashboard();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Update dashboard
        function updateDashboard() {
            updateSummaryCards();
            updateCharts();
            updateInsights();
            updateTransactionsList();
            updateCategoryFilter();
        }

        function updateSummaryCards() {
            const income = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const expenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const balance = income - expenses;

            document.getElementById('totalIncome').textContent = `$${income.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `$${expenses.toLocaleString()}`;
            document.getElementById('netBalance').textContent = `$${balance.toLocaleString()}`;
            document.getElementById('transactionCount').textContent = transactions.length.toLocaleString();
        }

        function updateCharts() {
            createCategoryChart();
            createTrendsChart();
        }

        function createCategoryChart() {
            const categoryTotals = {};
            const expenseTransactions = transactions.filter(t => t.Amount < 0);
            
            expenseTransactions.forEach(t => {
                const category = t.Category || 'Miscellaneous';
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.abs(t.Amount);
            });

            const sortedCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 8);

            const labels = sortedCategories.map(([category]) => category);
            const data = sortedCategories.map(([,amount]) => amount);
            const colors = labels.map(category => 
                categoryMappings.categories[category]?.color || '#adb5bd'
            );

            if (charts.category) charts.category.destroy();

            const ctx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createTrendsChart() {
            const monthlyData = {};
            
            transactions.forEach(t => {
                const monthKey = `${t.Date.getFullYear()}-${String(t.Date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expenses: 0 };
                }
                
                if (t.Amount > 0) {
                    monthlyData[monthKey].income += t.Amount;
                } else {
                    monthlyData[monthKey].expenses += Math.abs(t.Amount);
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const incomeData = sortedMonths.map(month => monthlyData[month].income);
            const expenseData = sortedMonths.map(month => monthlyData[month].expenses);

            if (charts.trends) charts.trends.destroy();

            const ctx = document.getElementById('trendsChart').getContext('2d');
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateInsights() {
            const insights = generateInsights();
            const insightsList = document.getElementById('insightsList');
            
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div>${insight.description}</div>
                </div>
            `).join('');
        }

        function generateInsights() {
            const insights = [];
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            
            // Category analysis
            const categoryTotals = {};
            transactions.filter(t => t.Amount < 0).forEach(t => {
                const category = t.Category || 'Miscellaneous';
                categoryTotals[category] = (categoryTotals[category] || 0) + Math.abs(t.Amount);
            });

            const topCategory = Object.entries(categoryTotals).sort(([,a], [,b]) => b - a)[0];
            if (topCategory) {
                const percentage = ((topCategory[1] / totalExpenses) * 100).toFixed(1);
                insights.push({
                    title: `Highest Spending Category: ${topCategory[0]}`,
                    description: `You spent $${topCategory[1].toLocaleString()} (${percentage}%) on ${topCategory[0]}. Consider if this aligns with your priorities.`
                });
            }

            // Savings rate
            const savingsRate = ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1);
            insights.push({
                title: `Savings Rate: ${savingsRate}%`,
                description: savingsRate > 20 ? 
                    'Excellent! You\'re saving over 20% of your income.' :
                    savingsRate > 10 ? 
                    'Good savings rate! Consider increasing to 20% if possible.' :
                    'Consider reducing expenses to increase your savings rate.'
            });

            // Dining analysis
            const diningSpend = categoryTotals['Food & Dining'] || 0;
            const grocerySpend = categoryTotals['Groceries'] || 0;
            if (diningSpend > grocerySpend) {
                insights.push({
                    title: 'Dining vs Groceries',
                    description: `You spend more on dining out ($${diningSpend.toLocaleString()}) than groceries ($${grocerySpend.toLocaleString()}). Cooking at home more could save money.`
                });
            }

            return insights;
        }

        function updateTransactionsList() {
            renderTransactions(transactions);
        }

        function renderTransactions(transactionsToShow) {
            const list = document.getElementById('transactionsList');
            
            list.innerHTML = transactionsToShow.slice(0, 50).map(t => {
                const category = categoryMappings.categories[t.Category] || categoryMappings.categories['Miscellaneous'];
                const amountClass = t.Amount > 0 ? 'positive' : 'negative';
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-date">${t.Date.toLocaleDateString()}</div>
                        <div class="transaction-description">${t.Description}</div>
                        <div class="transaction-amount ${amountClass}">$${Math.abs(t.Amount).toLocaleString()}</div>
                        <div class="transaction-category">
                            <span class="category-badge" style="background-color: ${category.color}">
                                ${category.icon} ${t.Category}
                            </span>
                        </div>
                        <div>${t.Account}</div>
                    </div>
                `;
            }).join('');
        }

        function updateCategoryFilter() {
            const categories = [...new Set(transactions.map(t => t.Category))].sort();
            const filter = document.getElementById('categoryFilter');
            
            filter.innerHTML = '<option value="">All Categories</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Search and filter functionality
        document.getElementById('searchInput').addEventListener('input', filterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', filterTransactions);

        function filterTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            
            let filtered = transactions;
            
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.Description.toLowerCase().includes(searchTerm) ||
                    t.Category.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedCategory) {
                filtered = filtered.filter(t => t.Category === selectedCategory);
            }
            
            renderTransactions(filtered);
        }

        // Export functionality
        function exportReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            const totalIncome = transactions.filter(t => t.Amount > 0).reduce((sum, t) => sum + t.Amount, 0);
            const totalExpenses = Math.abs(transactions.filter(t => t.Amount < 0).reduce((sum, t) => sum + t.Amount, 0));
            const balance = totalIncome - totalExpenses;
            
            return `PERSONAL FINANCE ANALYSIS REPORT
Generated: ${new Date().toLocaleDateString()}

SUMMARY
=======
Total Income: $${totalIncome.toLocaleString()}
Total Expenses: $${totalExpenses.toLocaleString()}
Net Balance: $${balance.toLocaleString()}
Total Transactions: ${transactions.length}
Savings Rate: ${((balance / totalIncome) * 100).toFixed(1)}%

SPENDING BY CATEGORY
==================
${Object.entries(transactions.filter(t => t.Amount < 0).reduce((acc, t) => {
    const cat = t.Category || 'Miscellaneous';
    acc[cat] = (acc[cat] || 0) + Math.abs(t.Amount);
    return acc;
}, {})).sort(([,a], [,b]) => b - a).map(([cat, amount]) => 
    `${cat}: $${amount.toLocaleString()}`
).join('\n')}

This report was generated by the Personal Finance Analyzer
Built with Claude AI assistance
`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoryMappings();
        });
    </script>
</body>
</html>

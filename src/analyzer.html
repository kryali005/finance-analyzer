<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ... (same CSS as before, omitted for brevity) ... */
        /* ADD: Pagination styles */
        .pagination {
            text-align: center;
            margin-top: 16px;
        }
        .pagination button {
            margin: 0 4px;
            padding: 4px 12px;
            border: none;
            background: #667eea;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
        }
        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Personal Finance Analyzer</h1>
            <p>Upload your transaction data and get intelligent insights powered by AI</p>
        </div>

        <div class="upload-section">
            <div class="file-upload">
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" />
                    <label for="csvFile" class="file-label">üìÅ Upload CSV File</label>
                </div>
                <button class="demo-btn" onclick="loadDemoData()">üéØ Try Demo Data</button>
                <div class="status" id="uploadStatus">Ready to upload</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your financial data...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="summary-cards">
                <div class="card income">
                    <div class="card-value" id="totalIncome">$0</div>
                    <div class="card-label">Total Income</div>
                </div>
                <div class="card expenses">
                    <div class="card-value" id="totalExpenses">$0</div>
                    <div class="card-label">Total Expenses</div>
                </div>
                <div class="card balance">
                    <div class="card-value" id="netBalance">$0</div>
                    <div class="card-label">Net Balance</div>
                </div>
                <div class="card transactions">
                    <div class="card-value" id="transactionCount">0</div>
                    <div class="card-label">Transactions</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Spending by Category</div>
                    <canvas id="categoryChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Trends</div>
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <div class="insights-panel">
                <div class="chart-title">üí° AI-Powered Insights</div>
                <div id="insightsList"></div>
            </div>

            <div class="transactions-table">
                <div class="chart-title">Recent Transactions</div>
                <div class="table-controls">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search transactions..." />
                    <select class="category-filter" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="transactions-list" id="transactionsList"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <div class="export-section">
                <button class="export-btn" onclick="exportReport()">üìä Export Analysis Report</button>
            </div>
        </div>
    </div>

    <script>
        let transactions = [];
        let filteredTransactions = [];
        let stats = {};
        let charts = {};
        let categoryMappings = {};
        const PAGE_SIZE = 50;
        let currentPage = 1;

        // Embedded category mappings (same as before)
        function loadCategoryMappings() {
            categoryMappings = {
                categories: {
                    "Groceries": { keywords: ["grocery", "whole foods", "supermarket", "costco"], merchants: [], color: "#6c5ce7", icon: "üõí" },
                    "Food & Dining": { keywords: ["restaurant", "coffee", "cafe", "starbucks", "dining", "mcdonald"], merchants: [], color: "#fdcb6e", icon: "üçî" },
                    "Shopping": { keywords: ["amazon", "store", "shop", "clothes", "retail"], merchants: [], color: "#00b894", icon: "üõçÔ∏è" },
                    "Housing": { keywords: ["rent", "mortgage", "apartment", "home"], merchants: [], color: "#0984e3", icon: "üè†" },
                    "Utilities": { keywords: ["electric", "water", "internet", "phone", "gas", "utility"], merchants: [], color: "#636e72", icon: "üí°" },
                    "Transportation": { keywords: ["uber", "lyft", "taxi", "bus", "subway", "transport"], merchants: [], color: "#e17055", icon: "üöó" },
                    "Entertainment": { keywords: ["movie", "cinema", "netflix", "spotify", "music", "entertain"], merchants: [], color: "#00b894", icon: "üé¨" },
                    "Recreation": { keywords: ["gym", "sports", "park", "recreation"], merchants: [], color: "#b2bec3", icon: "üèÄ" },
                    "Travel": { keywords: ["flight", "airline", "hotel", "travel"], merchants: [], color: "#0984e3", icon: "‚úàÔ∏è" },
                    "Miscellaneous": { keywords: ["other", "misc", "unknown", "cash", "atm", "fee"], merchants: [], color: "#adb5bd", icon: "‚ùì" }
                }
            };
        }

        // Debounce util
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // CSV Parsing using a Web Worker (if supported)
        let worker;
        function parseCSVWithWorker(csvText) {
            if (window.Worker) {
                if (!worker) {
                    worker = new Worker('csvWorker.js');
                }
                showLoading(true);
                worker.onmessage = function(e) {
                    const parsed = e.data;
                    onDataLoaded(parsed);
                    showLoading(false);
                };
                worker.postMessage(csvText);
            } else {
                // fallback to sync parse
                onDataLoaded(parseCSV(csvText));
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                const transaction = {};
                headers.forEach((header, index) => {
                    transaction[header] = values[index] || '';
                });
                // Auto-categorize if category is missing/generic
                if (!transaction.Category || transaction.Category === 'Miscellaneous') {
                    transaction.Category = categorizeTransaction(transaction.Description, parseFloat(transaction.Amount));
                }
                transaction.Amount = parseFloat(transaction.Amount) || 0;
                transaction.Date = new Date(transaction.Date);
                return transaction;
            }).filter(t => t.Amount !== 0);
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Categorization
        function categorizeTransaction(description, amount) {
            if (!categoryMappings.categories) return 'Miscellaneous';
            const desc = description.toLowerCase();
            for (const [category, data] of Object.entries(categoryMappings.categories)) {
                if (data.keywords && data.keywords.some(keyword => desc.includes(keyword.toLowerCase()))) {
                    return category;
                }
                if (data.merchants && data.merchants.some(merchant => desc.includes(merchant.toLowerCase()))) {
                    return category;
                }
            }
            return 'Miscellaneous';
        }

        // Main stats calculation
        function calculateStats(transactions) {
            let totalIncome = 0, totalExpenses = 0, categoryTotals = {}, monthlyData = {}, transactionCount = transactions.length;
            transactions.forEach(t => {
                if (t.Amount > 0) totalIncome += t.Amount;
                else if (t.Amount < 0) {
                    totalExpenses += Math.abs(t.Amount);
                    const cat = t.Category || 'Miscellaneous';
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + Math.abs(t.Amount);
                }
                // Monthly
                const monthKey = `${t.Date.getFullYear()}-${String(t.Date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expenses: 0 };
                if (t.Amount > 0) monthlyData[monthKey].income += t.Amount;
                else if (t.Amount < 0) monthlyData[monthKey].expenses += Math.abs(t.Amount);
            });
            return { totalIncome, totalExpenses, categoryTotals, transactionCount, monthlyData };
        }

        // UI updates
        function updateDashboard() {
            updateSummaryCards();
            updateCharts();
            updateInsights();
            renderTransactions();
            updateCategoryFilter();
        }

        function updateSummaryCards() {
            document.getElementById('totalIncome').textContent = `$${stats.totalIncome.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `$${stats.totalExpenses.toLocaleString()}`;
            document.getElementById('netBalance').textContent = `$${(stats.totalIncome - stats.totalExpenses).toLocaleString()}`;
            document.getElementById('transactionCount').textContent = stats.transactionCount.toLocaleString();
        }

        function updateCharts() {
            createCategoryChart();
            createTrendsChart();
        }

        function createCategoryChart() {
            const sortedCategories = Object.entries(stats.categoryTotals)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 8);
            const labels = sortedCategories.map(([c]) => c);
            const data = sortedCategories.map(([, a]) => a);
            const colors = labels.map(c => categoryMappings.categories[c]?.color || '#adb5bd');
            if (charts.category) charts.category.destroy();
            const ctx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        function createTrendsChart() {
            const sortedMonths = Object.keys(stats.monthlyData).sort();
            const incomeData = sortedMonths.map(m => stats.monthlyData[m].income);
            const expenseData = sortedMonths.map(m => stats.monthlyData[m].expenses);
            if (charts.trends) charts.trends.destroy();
            const ctx = document.getElementById('trendsChart').getContext('2d');
            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(month => {
                        const [year, monthNum] = month.split('-');
                        return new Date(year, monthNum - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Income',
                        data: incomeData,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Expenses',
                        data: expenseData,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateInsights() {
            const insightsList = document.getElementById('insightsList');
            const insights = generateInsights();
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div>${insight.description}</div>
                </div>
            `).join('');
        }

        function generateInsights() {
            const insights = [];
            const { totalIncome, totalExpenses, categoryTotals } = stats;
            // Category analysis
            const topCategory = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a)[0];
            if (topCategory) {
                const percentage = ((topCategory[1] / totalExpenses) * 100).toFixed(1);
                insights.push({
                    title: `Highest Spending Category: ${topCategory[0]}`,
                    description: `You spent $${topCategory[1].toLocaleString()} (${percentage}%) on ${topCategory[0]}.`
                });
            }
            // Savings rate
            const savingsRate = ((totalIncome - totalExpenses) / totalIncome * 100).toFixed(1);
            insights.push({
                title: `Savings Rate: ${savingsRate}%`,
                description: savingsRate > 20 ? 
                    'Excellent! You\'re saving over 20% of your income.' :
                    savingsRate > 10 ? 
                    'Good savings rate! Consider increasing to 20% if possible.' :
                    'Consider reducing expenses to increase your savings rate.'
            });
            // Dining vs groceries
            const diningSpend = categoryTotals['Food & Dining'] || 0;
            const grocerySpend = categoryTotals['Groceries'] || 0;
            if (diningSpend > grocerySpend) {
                insights.push({
                    title: 'Dining vs Groceries',
                    description: `You spend more on dining out ($${diningSpend.toLocaleString()}) than groceries ($${grocerySpend.toLocaleString()}). Cooking at home more could save money.`
                });
            }
            return insights;
        }

        // Paging for transactions
        function renderTransactions() {
            // If no filter, show all transactions
            const txs = filteredTransactions.length ? filteredTransactions : transactions;
            const list = document.getElementById('transactionsList');
            const pagination = document.getElementById('pagination');
            const pageCount = Math.ceil(txs.length / PAGE_SIZE);
            // Adjust current page if needed
            if (currentPage > pageCount) currentPage = pageCount || 1;
            const pageTxs = txs.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE);

            list.innerHTML = pageTxs.map(t => `
                <div class="transaction-item">
                    <div>${t.Date.toLocaleDateString()}</div>
                    <div>${t.Description}</div>
                    <div>${t.Category}</div>
                    <div>$${t.Amount.toLocaleString()}</div>
                </div>
            `).join('');

            // Pagination controls
            pagination.innerHTML = '';
            if (pageCount > 1) {
                for (let p = 1; p <= pageCount; p++) {
                    pagination.innerHTML += `<button ${p === currentPage ? 'disabled' : ''} onclick="goToPage(${p})">${p}</button>`;
                }
            }
        }
        window.goToPage = function(page) {
            currentPage = page;
            renderTransactions();
        };

        // Filtering/search with debounce
        function filterTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategory = document.getElementById('categoryFilter').value;
            filteredTransactions = transactions.filter(t => {
                const matchesSearch = !searchTerm ||
                    t.Description.toLowerCase().includes(searchTerm) ||
                    t.Category.toLowerCase().includes(searchTerm);
                const matchesCategory = !selectedCategory || t.Category === selectedCategory;
                return matchesSearch && matchesCategory;
            });
            currentPage = 1;
            renderTransactions();
        }
        const debouncedFilterTransactions = debounce(filterTransactions, 200);

        function updateCategoryFilter() {
            const select = document.getElementById('categoryFilter');
            const categories = Object.keys(stats.categoryTotals);
            select.innerHTML = `<option value="">All Categories</option>` + 
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Report export
        function exportReport() {
            const report = generateReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finance-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            const { totalIncome, totalExpenses, categoryTotals } = stats;
            const balance = totalIncome - totalExpenses;
            return `PERSONAL FINANCE ANALYSIS REPORT
Generated: ${new Date().toLocaleDateString()}

SUMMARY
=======
Total Income: $${totalIncome.toLocaleString()}
Total Expenses: $${totalExpenses.toLocaleString()}
Net Balance: $${balance.toLocaleString()}
Total Transactions: ${transactions.length}
Savings Rate: ${((balance / totalIncome) * 100).toFixed(1)}%

SPENDING BY CATEGORY
==================
${Object.entries(categoryTotals).sort(([,a],[,b])=>b-a).map(([cat,amount])=>
    `${cat}: $${amount.toLocaleString()}`
).join('\n')}

This report was generated by the Personal Finance Analyzer
`;
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('dashboard').style.display = show ? 'none' : 'block';
        }

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Use Web Worker if available
                    parseCSVWithWorker(e.target.result);
                    document.getElementById('uploadStatus').textContent = `${file.name} uploaded successfully!`;
                    document.getElementById('uploadStatus').className = 'status success';
                };
                reader.readAsText(file);
            }
        });

        // Demo data (same as before, but calls onDataLoaded)
        function loadDemoData() {
            showLoading(true);
            const demoCSV = `Date,Description,Amount,Category,Account
2024-04-20,Dick's Sporting Goods,234.78,Recreation,Credit Card
2024-04-19,Whole Foods Market,101.23,Groceries,Debit Card
2024-04-18,Apple Music,10.99,Entertainment,Credit Card
2024-04-17,Sewer Bill,43.22,Utilities,Checking
2024-04-16,McDonald's,7.89,Food & Dining,Credit Card
2024-04-15,Costco Wholesale,189.45,Groceries,Credit Card
2024-04-14,Uber Ride,19.67,Transportation,Credit Card
2024-04-13,Microsoft Store,99.99,Shopping,Credit Card
2024-04-12,Rent Payment,1850.00,Housing,Checking`;
            setTimeout(() => {
                onDataLoaded(parseCSV(demoCSV));
                document.getElementById('uploadStatus').textContent = 'Demo data loaded successfully!';
                document.getElementById('uploadStatus').className = 'status success';
                showLoading(false);
            }, 1000);
        }

        // After loading or parsing CSV, update state and UI
        function onDataLoaded(newTransactions) {
            transactions = newTransactions;
            stats = calculateStats(transactions);
            filteredTransactions = [];
            currentPage = 1;
            updateDashboard();
        }

        // Input event listeners
        document.getElementById('searchInput').addEventListener('input', debouncedFilterTransactions);
        document.getElementById('categoryFilter').addEventListener('change', debouncedFilterTransactions);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCategoryMappings();
        });
    </script>
</body>
</html>
